ifndef::full-version[]
include::../headers.adoc[]
:toc: macro
:toc-title: What's the plan for this lesson?

toc::[]
endif::full-version[]

== Lesson 5: When several containers talk to each other.

=== External network

==== Direct communication

How to make 2 containers talking to each other via the network?
Which IP address to use? `127.0.0.1`? `random.random.random.random`?

.Let's use a case of study:

First, run a simple nginx container with `docker run -d --name webapp nginx`.

Then run, with the `-it` param, a `gscheibel/docker4devs:curl` container (which is simply a glorified Debian with curl installed).

.How to ping the nginx container from the curl one?

By default, the docker engine manages a `bridge` network which is accessible from all the containers.
Try to inspect the `webapp` container using `docker inspect webapp`.

At the end, you should be able to see the network configurations for this container.

:ipaddress: 172.17.0.4
[source, json, subs="attributes"]
----
{
  "Networks": {
      "bridge": {
          "IPAMConfig": null,
          "Links": null,
          "Aliases": null,
          "NetworkID": "ade9ac6b5007c77445544784f05f423d446e764c840c8355221547981c9cd6c3",
          "EndpointID": "5307c8dab802788a78e3fba5d82c8480360bd6a125ac95690c8fcb15773bcf3f",
          "Gateway": "172.17.0.1",
          "IPAddress": "{ipaddress}", <!--1-->
          "IPPrefixLen": 16,
          "IPv6Gateway": "",
          "GlobalIPv6Address": "",
          "GlobalIPv6PrefixLen": 0,
          "MacAddress": "02:42:ac:11:00:04",
          "DriverOpts": null
      }
  }
}
----

<1> The `IPAddress` field gives you the IP address to use to connect to this container.

Now we have the ip address, go to your `docker4devs:curl` container and try:

[source, subs="attributes"]
$ curl -I {ipaddress}

.Expected output

[source]
----
HTTP/1.1 200 OK
Server: nginx/1.13.5
Date: Tue, 31 Oct 2017 13:17:40 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 08 Aug 2017 15:25:00 GMT
Connection: keep-alive
ETag: "5989d7cc-264"
Accept-Ranges: bytes
----

==== Specific network

Knowing each container's IP address is cumbersome and doesn't isolate much (inside of a same host).
To mitigate this situation, the engine provides the https://docs.docker.com/engine/reference/commandline/network/[`network` command].

The idea is to create a subnetwork (bridge by default) which  will be shared by several containers.
Unlike the default bridge, container within a subnetwork can be accessed by their name.

To associate a subnetwork a container (at creation time), the `--network=[NAME]` parameter of the `docker run` command can be used.

.Exercise

Create a subnetwork named `d4d-network`.
Start a new nginx container named `webapp` and associate it to the `d4d-network` subnetwork.
Finally do the same with a `curl` container.

Then in your `curl` container you should be able to run:

[source]
$ curl -I webapp

include::solutions.adoc[tags=subnetwork]


=== Complex builder container

==== Triggering actions on a child image at build time

==== The builder/run pattern

==== Multistage build
